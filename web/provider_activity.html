<!DOCTYPE html>
<html lang="dk">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Udbydere - visning og kontakt info kliks</title>
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.13/d3.min.js"></script>
    <script src="http://sofa.lokalebasen.dk:5984/public/js/Chart.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.js"></script>

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src='http://cdn.ractivejs.org/latest/ractive.js'></script>
    <script src='http://sofa.lokalebasen.dk:5984/public/js/ractive-events-tap.js'></script>
    <script src='http://sofa.lokalebasen.dk:5984/public/js/jquery.formatDateTime.min.js'></script>
    <style>
      .sortable{
        cursor: pointer;
        color: black;
        font-size: 12pt;
      }
      .unsorted {
        color: #c0c0c0;
      }

      /* iPhone portrait*/
      @media (max-width: 480px) and (max-width: 767px) {
        h1{
          font-size: 24px;
        }
        .sortable {
          /*color: green;*/
          font-size: 10pt;
        }
      }
      /* iPad portrait*/
      @media (min-width: 768px) and (max-width: 979px) {
        .sortable {
          /*color: yellow;*/
        }
      }
      @media (min-width: 1200px) {
        .sortable {
          /*color: red;*/
        }
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <h1>Udbydere med visning af kontakt info</h1>
      <script id='providers_template' type='text/ractive'>
        <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
          <div class="panel panel-primary">
            <div class="panel-heading" role="tab" id="headingOne">
              <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                  Udbydere
                </a>
              </h4>
            </div>
            <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
              <div class="panel-body">
                <table class='table table-condensed'>
                  <thead>
                    <tr>
                      <th class='sortable' on-tap='sort:id'>
                        <span class='{{ sortColumn === "id" ? "glyphicon glyphicon-sort-by-attributes" : "unsorted glyphicon glyphicon-sort" }}'></span>Id
                      </th>
                      <th class='sortable' on-tap='sort:company_name'>
                        <span class='{{ sortColumn === "company_name" ? "glyphicon glyphicon-sort-by-attributes" : "unsorted glyphicon glyphicon-sort" }}'></span>Navn
                      </th>
                      <th class='sortable' on-tap='sort:total_active'>
                        <span class='{{ sortColumn === "total_active" ? "glyphicon glyphicon-sort-by-attributes" : "unsorted glyphicon glyphicon-sort" }}'></span>Aktive lejemål
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                  {{#each sort(providers, sortColumn) :num}}
                    <tr>
                      <td>{{id}}</td>
                      <td><a href="#" on-click="show">{{company_name}}</a></td>
                      <td>
                        <span class="badge">
                          {{total_active}}
                        </span>
                      </td>
                    </tr>
                  {{/each}}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="panel panel-primary">
            <div class="panel-heading" role="tab" id="headingTwo">
              <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                  <h4>{{provider.company_name}} <small><span class="badge">{{provider.total_active}}</small></badge></h4>
                </a>
              </h4>
            </div>
            <div id="collapseTwo" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingTwo">
              <div class="panel-body">
                <table class='table table-condensed'>
                  <thead>
                    <tr>
                      <th>År-uge</th>
                      <th>Visninger</th>
                      <th>Info-kliks</th>
                      <th>Ratio</th>
                      <!--
                      <th>"Stacked" statistik</th>
                      -->
                    </tr>
                  </thead>
                  <tbody>
                    {{#each provider.week_stats}}
                      <tr>
                        <td>{{week}}</td>
                        <td>{{formatNull(shown)}}</td>
                        <td>{{formatNull(clicked)}}</td>
                        <td>
                          <small>{{ratio(shown, clicked).shown_per}}/{{ratio(shown, clicked).clicked_per}}</small>
                        </td>
                      </tr>
                    {{/each}}
                      <tr>
                        <td><strong>Total</strong></td>
                        <td><strong>{{provider.shown_sum}}</strong></td>
                        <td><strong>{{provider.clicked_sum}}</strong></td>
                        <td>
                          <small>{{ratio(provider.shown_sum, provider.clicked_sum).shown_per}}/{{ratio(provider.shown_sum, provider.clicked_sum).clicked_per}}</small>
                        </td>
                      </tr>
                  </tbody>
                </table>
                <hr>
                <canvas style="padding-right: 20px" id="myChart" width="800" height="200"></canvas>
              </div>
            </div>
          </div>
        </div>
      </script>

      <div id='providers_container'></div>
    </div>
    <script type="text/javascript">
      var DATABASE = "http://sofa-staging.lokalebasen.dk:5984";
      var providers = new Ractive({
        el: 'providers_container',
        template:  '#providers_template',
        data: {
          provider: null,
          providers: [],
          to_json: function ( provider ) {
            return JSON.stringify(provider);
          },
          ratio: function(shown, clicked){
            ratio = {}
            if(shown == null)
              shown = 0;
            if(clicked == null)
              clicked = 0;
            sum = shown+clicked;
            ratio.shown_per = (shown/(sum/100.0)).toFixed(0);
            ratio.clicked_per = (clicked/(sum/100.0)).toFixed(0);
            return ratio;
          },
          formatNull: function(value){
            if(value)
              return value;
            else
              return 0;
          },
          dateFormat: function(str_date){
            date = new Date(Date.parse(str_date));
            return $.formatDateTime('dd/mm/yy hh:ii', date);
          },
          statusClass: function(status){
            if(status!="finished")
              return "warning";
            else
              return "success";
          },
          sort: function ( array, column ) {
            array = array.slice();
            return array.sort( function ( a, b ) {
              return a[ column ] < b[ column ] ? -1 : 1;
            });
          },
          sortColumn: 'company_name'
        }
      });
      providers.on( 'show', function ( event ) {
        showProvider(event.context)
      });
      providers.on( 'sort', function ( event, column ) {
        this.set( 'sortColumn', column );
      });

      function setProviders() {
        url = DATABASE + "/dk_location_contact_info_shown/_design/stats/_view/grp_by_provider?group=true"
        $.get(url, function( data ) {
          rows = JSON.parse(data).rows
          for (var j = 0; j < rows.length; j++) {
            addProvider(rows[j].key,rows[j].value);
          }
        });
      }

      function addProvider(uuid, total_shown_info_clicks) {
        url = DATABASE + "/provider_active_locations/" + uuid
        $.get(url, function( data ) {
          provider = JSON.parse(data)
          provider.total_shown_info_clicks = total_shown_info_clicks;
          providers.push( 'providers', provider );
        });
      }

      function showProvider(provider){
        setLocationsShown(provider)
        $('#collapseOne').collapse('hide');
      }

      function weekQuery(provider){
        startkey = 'startkey=["' + provider.uuid + '",2014,40]';
        endkey = 'endkey=["' + provider.uuid + '",'+moment().weekYear()+','+ moment().week()+']';
        query = startkey + "&" + endkey + "&group=true";
        return query;
      }

      function setLocationsShown(provider){
        url = DATABASE + "/dk_location_shown/_design/stats/_view/week?" + weekQuery(provider)
        $.get(url, function( data ) {
          locations_shown = JSON.parse(data).rows
          shown_sum = 0;
          week_stats = {}
          for(i = 0; i < locations_shown.length; i++){
            value = locations_shown[i].value
            key = locations_shown[i].key[1]+"-"+locations_shown[i].key[2]
            shown_sum = shown_sum + value
            week_stats[key] = { shown: value, week: key }
          }
          provider.shown_sum = shown_sum;
          provider.locations_shown = locations_shown;
          provider.week_stats = week_stats;
          setLocationsInfoClicked(provider);
        });
      }

      function setLocationsInfoClicked(provider){
        url = DATABASE + "/dk_location_contact_info_shown/_design/stats/_view/week?" + weekQuery(provider)
        $.get(url, function( data ) {
          locations_info_clicked = JSON.parse(data).rows
          clicked_sum = 0;
          for(i = 0; i < locations_info_clicked.length; i++){
            value = locations_info_clicked[i].value
            week_stat = week_stats[locations_info_clicked[i].key[1]+"-"+locations_info_clicked[i].key[2]]
            clicked_sum = clicked_sum + value
            week_stat['clicked'] = value
          }
          provider.clicked_sum = clicked_sum;
          provider.locations_info_clicked = locations_info_clicked
          providers.set( 'provider', provider );
          setGraph(provider);
        });
      }

      function valueOrZero(value){
        if(value)
          return value;
        else
          return 0;
      }

      function setGraph(provider){
        var data1 = [];
        var data2 = [];
        var labels = Object.keys(week_stats);
        for(i=0;i<labels.length;i++){
          label = labels[i]
          data1.push(valueOrZero(week_stats[label].shown));
          data2.push(valueOrZero(week_stats[label].clicked));
        }
        var options = {
          scaleShowGridLines : true,
          responsive : true,
          maintainAspectRatio: true,
          pointHitDetectionRadius: 5,
          bezierCurve: false
      };
        var data = {
          labels: labels,
          datasets: [
              {
                  label: "Visninger",
                  lineColor: "rgba(220,220,220,1)",
                  fillColor: "rgba(220,220,220,0.2)",
                  strokeColor: "rgba(220,220,220,1)",
                  pointColor: "rgba(220,220,220,1)",
                  pointStrokeColor: "#fff",
                  pointHighlightFill: "#fff",
                  pointHighlightStroke: "rgba(220,220,220,1)",
                  data: data1
              },
              {
                  label: "Info-kliks",
                  lineColor: "rgba(151,187,205,1)",
                  fillColor: "rgba(151,187,205,0.2)",
                  strokeColor: "rgba(58,185,3,1)",
                  pointColor: "rgba(58,185,3,1)",
                  pointStrokeColor: "#fff",
                  pointHighlightFill: "#fff",
                  pointHighlightStroke: "rgba(58,185,3,1)",
                  data: data2
              }
          ]
        };

        if(ctx==null)
          ctx = $("#myChart").get(0).getContext("2d");
        else
          myLineChart.destroy();
        myLineChart = new Chart(ctx).Line(data, options);
      }
      var ctx = null;
      var myLineChart = null;
      setProviders();
    </script>


  </body>
</html>
