<!DOCTYPE html>
<html lang="dk">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Aktive udbydere - emne visninger</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">

    <style>
      .sortable{
        cursor: pointer;
        color: black;
        font-size: 12pt;
      }
      .unsorted {
        color: #c0c0c0;
      }

      /* iPhone portrait*/
      @media (max-width: 480px) and (max-width: 767px) {
        h1{
          font-size: 24px;
        }
        .sortable {
          /*color: green;*/
          font-size: 10pt;
        }
      }
      /* iPad portrait*/
      @media (min-width: 768px) and (max-width: 979px) {
        .sortable {
          /*color: yellow;*/
        }
      }
      @media (min-width: 1200px) {
        .sortable {
          /*color: red;*/
        }
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <h1>Capitex providers</h1>
      <script id='providers_template' type='text/ractive'>
        <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
          <div class="panel panel-primary">
            <div class="panel-heading" role="tab" id="headingOne">
              <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                  Providers
                </a>
              </h4>
            </div>
            <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
              <div class="panel-body">
                <table class='table table-condensed'>
                  <thead>
                    <tr>
                      <th class='sortable' on-tap='sort:id'>
                        <span class='{{sortIcon("id")}}'></span>Id
                      </th>
                      <th class='sortable' on-tap='sort:company_name'>
                        <span class='{{sortIcon("company_name")}}'></span>Navn
                      </th>
                      <th class='sortable' on-tap='sort:total_active'>
                        <span class='{{sortIcon("total_active")}}'></span>Aktive lejem√•l
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                  {{#each sort(providers, sortColumn) :num}}
                    <tr>
                      <td>{{id}}</td>
                      <td><a href="#" on-click="show">{{company_name}}</a></td>
                      <td>
                        <span class="badge">
                          {{total_active}}
                        </span>
                      </td>
                    </tr>
                  {{/each}}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="panel panel-primary">
            <div class="panel-heading" role="tab" id="headingTwo">
              <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                  <h4>{{provider.company_name}} <small><span class="badge">{{provider.total_active}}</small></badge></h4>
                </a>
              </h4>
            </div>
            <div id="collapseTwo" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingTwo">
              <div class="panel-body">
                <table class='table table-condensed'>
                  <thead>
                    <tr>
                      <th>Guid</th>
                      <th>Address</th>
                      <th>Images</th>
                      <th>Files</th>
                    </tr>
                  </thead>
                  <tbody>
                    {{#each locations}}
                      <tr>
                        <td><a href="#" on-click="showLocation">{{guid}}</a></td>
                        <td>{{address.street_address}},{{address.postal_code}} {{address.postal_city}}</td>
                        <td>
                          <ul>
                          {{#each images}}
                            <li>
                              <a href="/capitex_locations/{{guid}}/{{image.guid}}.{{image.file_type.toLowerCase()}}" target="_blank">
                                {{image.name}}
                              </a>, {{image.file_type}} - {{image.category}}
                          {{/each}}
                          </ul>
                        </td>
                        <td>
                          {{#each files}}
                            <ul>
                              <li>
                                <a href="/capitex_locations/{{guid}}/{{file.guid}}.{{file.file_type.toLowerCase()}}" target="_blank">
                                  {{file.name}}
                                </a>, {{file.file_type}} - {{file.category}}
                            </ul>
                          {{/each}}
                        </td>
                      </tr>
                    {{/each}}
                  </tbody>
                </table>

              </div>
            </div>
          </div>
        </div>
      </script>

      <div id='providers_container'></div>
    </div>
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src='http://cdn.ractivejs.org/latest/ractive.js'></script>
    <script src='http://sofa.lokalebasen.dk:5984/public/js/ractive-events-tap.js'></script>
    <script type="text/javascript">
      var DATABASE = "http://192.168.1.152:5984";
      var providers = new Ractive({
        el: 'providers_container',
        template:  '#providers_template',
        data: {
          provider: null,
          providers: [],
          // locations: [],
          to_json: function ( provider ) {
            return JSON.stringify(provider);
          },
          formatNull: function(value){
            if(value)
              return value;
            else
              return 0;
          },
          dateFormat: function(str_date){
            date = new Date(Date.parse(str_date));
            return $.formatDateTime('dd/mm/yy hh:ii', date);
          },
          sortIcon: function(column){
            if(column === this.get('sortColumn')){
              icon = "glyphicon glyphicon-sort-by-attributes"
              return this.get('sortOrder') === "asc" ? icon+"-alt" :icon;
            }
            else
              return "unsorted glyphicon glyphicon-sort";
          },
          sortLocationIcon: function(column){
            if(column === this.get('sortLocationColumn')){
              icon = "glyphicon glyphicon-sort-by-attributes"
              return this.get('sortLocationOrder') === "asc" ? icon+"-alt" :icon;
            }
            else
              return "unsorted glyphicon glyphicon-sort";
          },
          statusClass: function(status){
            if(status!="finished")
              return "warning";
            else
              return "success";
          },
          stateClass: function(state){
            return classFromState(state);
          },
          sort: function ( array, column ) {
            sortOrder = this.get('sortOrder');
            array = array.slice();
            return array.sort( function ( a, b ) {
              if(sortOrder=="asc")
                return a[ column ] > b[ column ] ? -1 : 1;
              else
                return a[ column ] < b[ column ] ? -1 : 1;
            });
          },
          sortLocation: function ( array, column ) {
            sortOrder = this.get('sortLocationOrder');
            array = array.slice();
            return array.sort( function ( a, b ) {
              if(sortOrder=="asc")
                return a[ column ] > b[ column ] ? -1 : 1;
              else
                return a[ column ] < b[ column ] ? -1 : 1;
            });
          },
          sortColumn: 'company_name',
          sortOrder: 'asc',
          sortLocationColumn: 'clicks',
          sortLocationOrder: 'asc'
        }
      });
      providers.on( 'show', function ( event ) {
        showProvider(event.context)
      });
      providers.on( 'showLocation', function ( event ) {
        showLocation(event.context)
      });
      providers.on( 'sortLocation', function ( event, column ) {
        current_sort = this.get('sortLocationColumn');
        new_sort = column;
        this.set( 'sortLocationColumn', column );
        this.set( 'sortLocationOrder', (this.get('sortLocationOrder') == 'asc' ? 'desc' : 'asc') );
        if(current_sort!=new_sort)
          this.set( 'sortLocationColumn', column );
        else
          this.set( 'sortLocationColumn', column );
      });

      providers.on( 'sort', function ( event, column ) {
        current_sort = this.get('sortColumn');
        new_sort = column;
        this.set( 'sortOrder', (this.get('sortOrder') == 'asc' ? 'desc' : 'asc') );
        if(current_sort!=new_sort)
          this.set( 'sortColumn', column );
        else
          this.set( 'sortColumn', column );
      });

      function classFromState(state)
      {
        switch (state) {
          case "active":
            return "success";
            break;
          case "closed":
            return "danger"
            break;
          case "new":
            return "warning";
            break;
          default:
            return "primary";
        }
      }

      function setProviders() {

        url = DATABASE + "/capitex_locations/_design/lists/_view/providers?group=true"
        $.get(url, function( data ) {
          rows = JSON.parse(data).rows
          provider_list = []
          for (var j = 0; j < rows.length; j++) {
            value = rows[j].value
            key = rows[j].key
            provider = {id: key[1], company_name: key[0], total_active: value }
            provider_list.push(provider)
          }
          provider_list.sort(function(a, b) {
            return b.active - a.active;
          });
          providers.set( 'providers', provider_list );
        });
      }

      function showProvider(provider){
        setLocations(provider);
        console.log(provider)
        providers.set( 'provider', provider );
        $('#collapseOne').collapse('hide');
      }

      function showLocation(location){
        // Some nice popup
      }



      function setLocations(provider){
        locations_list = []

        url = DATABASE + "/capitex_locations/_design/lists/_view/by_provider_id?key=\"" + provider.id +"\""
        $.get(url, function( data ) {
          locations = JSON.parse(data).rows
          for(i = 0; i < locations.length; i++){
            locations_list.push(locations[i].value)
          }
        });
        providers.set( 'locations', locations_list );
      }

      function valueOrZero(value){
        if(value)
          return value;
        else
          return 0;
      }

      setProviders();
    </script>


  </body>
</html>
