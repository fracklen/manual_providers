<!DOCTYPE html>
<html lang="dk">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Versions</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
      .sortable{
        cursor: pointer;
        color: black;
        font-size: 12pt;
      }
      .unsorted {
        color: #c0c0c0;
      }

      /* iPhone portrait*/
      @media (max-width: 480px) and (max-width: 767px) {
        h1{
          font-size: 24px;
        }
        .sortable {
          /*color: green;*/
          font-size: 10pt;
        }
      }
      /* iPad portrait*/
      @media (min-width: 768px) and (max-width: 979px) {
        .sortable {
          /*color: yellow;*/
        }
      }
      @media (min-width: 1200px) {
        .sortable {
          /*color: red;*/
        }
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <h1>Event reports <i id="spinner" class="fa fa-spinner fa-spin"></i></h1>
      <script id='reports_template' type='text/ractive'>
        <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">

          <div class="panel panel-primary">
            <div class="panel-heading" role="tab" id="providerHeading">
              <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#providersCollapse" aria-expanded="true" aria-controls="providersCollapse">
                  Reports <span class="badge">{{reports.length}}</small>
                </a>
              </h4>
            </div>
            <div id="providersCollapse" class="panel-collapse" role="tabpanel" aria-labelledby="providerHeading">
              <div class="panel-body">
                <table class='table table-condensed'>
                  <thead>
                    <tr>
                      <th class='sortable' on-tap='sort:date'>
                        <span class='{{ sortColumn === "date" ? "glyphicon glyphicon-sort-by-attributes" : "unsorted glyphicon glyphicon-sort" }}'></span>Date
                      </th>
                      <th class='sortable' on-tap='sort:name'>
                        <span class='{{ sortColumn === "name" ? "glyphicon glyphicon-sort-by-attributes" : "unsorted glyphicon glyphicon-sort" }}'></span>Navn
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                  {{#each reports}}
                    <tr>
                      <td>{{ dateFormat(date) }}</td>
                      <td><a href="#" on-click="show" class="text-capitalize">{{name}}</a></td>
                      <td><a class="btn btn-danger btn-xs" href="#" on-click="deleteReport">Delete</a></td>
                    </tr>
                  {{/each}}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
            <br>
            <br>
          {{#if location}}
            <div class="panel panel-default">
              <div class="panel-heading" role="tab" id="reportHeading">
                <div class="panel-title">
                <button type="button" class="close" on-click="closeLocation" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                  <h3 class="text-capitalize">{{location.address}}
                    <span class="label label-{{stateClass(location.state)}}">{{location.state}}</span>
                  </h3>
                  <i class="fa fa-lg fa-floppy-o"></i> {{dateFormat(location.created_at)}}
                </div>
              </div>

              <div class="panel-body">
                <br>
                  <table class='table table-striped'>
                    <thead>
                    <tr>
                      <th>#</th>
                      <th>From state</th>
                      <th>To state</th>
                      <th>Date</th>
                      <th>Event</th>
                    </tr>
                    </thead>

                    {{#each location.versions:num}}
                      <tbody>
                      <tr>
                        <td>{{num+1}}</td>
                        <td>{{previous_state}}</td>
                        <td><span class="label label-{{statesClass(previous_state, current_state)}}">{{current_state}}</td>
                        <td>{{dateFormat(date)}}</td>
                        <td>{{event}}</td>
                      </tr>
                      </tbody>
                    {{/each}}
                  </table>
              </div>
            </div>
            <br>
            <br>
          {{/if}}
            <div class="well">
              <canvas style="padding-right: 20px" id="myChart" width="800" height="200"></canvas>
            </div>
          {{#if report}}
            <div class="panel panel-default">
              <div class="panel-heading" role="tab" id="reportHeading">
                <div class="panel-title">
                  <h3 class="text-capitalize">{{report.company_name}}
                    <small>{{dateFormat(report.end_time)}}</small>
                  </h3>
                </div>
              </div>
              <div class="panel-body">
                <table class='table table-condensed'>
                  <thead>
                    <tr>
                      <th>Id</th>
                      <th>Created</th>
                      <th>Address</th>
                       <th>State</th>
                      <th>Active periods</th>
                      <th>Versions</th>
                      <th>Show</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>
                        <span class="label label-primary">{{report.locations.length}}</span>
                        <span class="label label-success">{{active(report)}}</span>
                        <span class="label label-warning">{{nothing(report)}}</badge></td>
                      <td></td>
                      <td></td>
                    </tr>
                    {{#each sort(report.locations, 'state')}}
                      <tr>
                        <td>{{uuid}}</td>
                        <td>{{dateFormat(created_at)}}</td>
                        <td>{{address}}</td>
                        <td><span class="label label-{{stateClass(state)}}">{{state}}</span></td>
                        <td>{{activePeriods(active_periods)}}</td>
                        <td>{{versions.length}}</td>
                        <td><a class="btn btn-primary btn-xs" href="#" on-click="showLocation">Show</a></td>
                      </tr>
                    {{/each}}

                  </tbody>
                </table>
              </div>
            </div>
          {{/if}}
        </div>
      </script>
      <div id='reports_container'></div>
    </div>
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="http://sofa.lokalebasen.dk:5984/public/js/Chart.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src='http://cdn.ractivejs.org/latest/ractive.js'></script>
    <script src='http://sofa.lokalebasen.dk:5984/public/js/ractive-events-tap.js'></script>
    <script type="text/javascript">

      function isActive(location) {
        return location.state == 'active';
      }

      function isNew(location) {
        return location.state == 'new';
      }

      function classFromState(state)
      {
        switch (state) {
          case "active":
            return "success";
            break;
          case "closed":
            return "danger"
            break;
          case "new":
            return "warning";
            break;
          default:
            return "primary";
        }
      }

      var DATABASE = "http://sofa-staging.lokalebasen.dk:5984";

      var reports = new Ractive({
        el: 'reports_container',
        template:  '#reports_template',
        data: {
          report: null,
          location: null,
          providers: [],
          reports: [],
          dateFormat: function(str_date){
            date = moment(str_date,"YYYY-MM-DD HH:mm:ss");
            return date.format("DD/MM/YYYY HH:mm");
          },
          sort: function ( array, column ) {
            array = array.slice();
            return array.sort( function ( a, b ) {
              return a[ column ] < b[ column ] ? -1 : 1;
            });
          },
          statesClass: function(previous_state, current_state){
            if(previous_state!=current_state)
              return classFromState(current_state);
            else
              return "default";

          },
          stateClass: function(state){
            return classFromState(state);
          },
          active: function(report){
            return report.locations.filter(isActive).length;
          },
          nothing: function(report){
            return report.locations.filter(isNew).length;
          },
          activePeriods: function(activePeriods){
            return activePeriods.map(function(ap){ return ap.active_days;});
          }
        }
      });
      reports.on( 'show', function ( event ) {
        reports.set( 'location', null );
        showProviderReport(event.context.id)
      });
      reports.on( 'showLocation', function ( event ) {
        console.log(event.context)
        reports.set( 'location', event.context );
      });
      reports.on( 'closeLocation', function ( event ) {
        reports.set( 'location', null );
      });
      reports.on( 'deleteReport', function ( event ) {
        if(confirm("Warning, you are about to delete a report !"))
          deleteReport(event.context.id, event.context.rev);
      });

      function showProviderReport(id) {
        showSpinner();
        url = DATABASE + "/event_report/"+id
        $.get(url, function( data ) {
          report = JSON.parse(data);
          report.locations.forEach(setActivePeriods);

          setGraph(report.locations)
          reports.set( 'report', report );
          hideSpinner();
        });
      }

      function showSpinner(){
        $("#spinner").show();
      }
      function hideSpinner(){
        $("#spinner").hide();
      }

      function deleteReport(id, rev){
        shown_report = reports.get('report');
        if(shown_report && shown_report._id==id){ reports.set( 'report', null ); }
        doc_url = DATABASE+"/event_report/"+id+"?rev="+rev;
        $.ajax({
            url: doc_url,
            type: 'DELETE',
            success: function(result) {
              reports.set( 'reports', [] );
              setReports();
            }
        });
      }

      function activeDays(start_time, end_time){
        from = moment(start_time)
        to = moment(end_time)
        if(!start_time)
          return -1;
        var duration = moment.duration(to.diff(from));
        return Math.ceil(duration.asDays());
      }

      function hasChanged(change){
        return change.current_state != change.previous_state
      }

      function setPeriods(location){
        periods = [];
        changes = location.versions;
        state = location.state;
        for(i=1;i<changes.length;i++){
          if((i+1)<changes.length)
            changes[i].current_state = changes[i+1].previous_state;
          else
            changes[i].current_state = location.state;
          periods.push(changes[i])
        }
        location.periods = periods
      }

      function setActivePeriods(location){
        setPeriods(location)
        changes = location.periods
        state_changes = changes.filter(hasChanged)
        active_periods = []
        start_change = {}

        for(i=0;i<state_changes.length;i++){
          sc = state_changes[i]
          if(sc.current_state == "active")
            start_change.date = sc.date

          if(sc.current_state == "closed"){


            start_time = start_change.date ? moment(start_change.date, "YYYY-MM-DD HH:mm:ss").toDate() : start_change.date
            end_time = sc.date ? moment(sc.date, "YYYY-MM-DD HH:mm:ss").toDate() : sc.date
            active_periods.push( { start_date: start_time, end_date: end_time, active_days: activeDays(start_time, end_time)  });
            start_change.date = null
          }
        }
        // Still active ?
        if(start_change.date){
          start_time = start_change.date ? moment(start_change.date, "YYYY-MM-DD HH:mm:ss").toDate() : start_change.date;
          active_periods.push({ start_date: start_time, end_date: null, active_days: activeDays(start_time, Date.now())})
        }
        location.active_periods = active_periods
      }

      function setReports(){
        url = DATABASE + '/event_report/_design/lists/_view/reports'
        $.get(url, function( data ) {
          rows = JSON.parse(data).rows;
          for (var j = 0; j < rows.length; j++) {
            report = {}
            report.id = rows[j].id;
            report.rev = rows[j].key[1];
            report.name = rows[j].value[0];
            report.date = rows[j].value[1];
            reports.push( 'reports', report );
          }
        });
      }

      function includedByPeriod(period, date){
        m_date = moment(date);

        if(period.start_date && period.end_date){
          s_date = moment(period.start_date);
          e_date = moment(period.end_date);
          return (s_date.isBefore(m_date) || s_date.isSame(m_date)) && (e_date.isAfter(m_date) || e_date.isSame(m_date));
        }
        else{
          if(period.end_date && moment(period.end_date).isBefore(m_date))
            return false;
          if(period.start_date && moment(period.start_date).isBefore(m_date))
            return true;
        }
      }

      function wasActiveOnDate(location, date){
        return location.active_periods.some(
          function(period){
            return includedByPeriod(period, date);
          }
        );
      }

      function activeLocations(date, locations){
        return locations.filter(
          function(location){
            return wasActiveOnDate(location,date);
          }
        );
      }

      function setGraph(locations){
        data = []
        labels = []
        var date = moment().subtract(12, 'M').startOf('month');
        daysAgo = 365;
        sum = 0;
        for(i=1;i<=daysAgo;i++){
          date = date.add(1, 'd');
          sum += activeLocations(date,locations).length
          if(i%7==0) { // Take mean 7 days, to make room for labels
            labels.push(date.format("DD/MM/YYYY"));
            data.push(Math.ceil(sum/7)); // Calculate mean value
            // data.push(activeLocations(date,locations).length);
            sum = 0;
          }
        }

        var options = {
          pointDot : false,
          scaleShowGridLines : true,
          responsive : true,
          maintainAspectRatio: true,
          pointHitDetectionRadius: 5,
          bezierCurve: true,
        };
        var data = {
          labels: labels,
          datasets: [
            {
              label: "Aktive",
              lineColor: "rgba(220,220,220,1)",
              fillColor: "rgba(220,220,220,0.2)",
              strokeColor: "rgba(220,220,220,1)",
              pointColor: "rgba(220,220,220,1)",
              pointStrokeColor: "#fff",
              pointHighlightFill: "#fff",
              pointHighlightStroke: "rgba(220,220,220,1)",
              data: data
            }
          ]
        };

        if(ctx==null)
          ctx = $("#myChart").get(0).getContext("2d");
        else
          myLineChart.destroy();
        myLineChart = new Chart(ctx).Line(data, options);
      }

      var ctx = null;
      var myLineChart = null;
      setReports();
      $("#spinner").hide();

      $(function () {
        $('[data-toggle="popover"]').popover()
      })
    </script>
  </body>
</html>
