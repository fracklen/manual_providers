<!DOCTYPE html>
<html lang="dk">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Manual providers</title>
    <script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src='https://cdn.ractivejs.org/0.6.1/ractive.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.js"></script>
    <style>
      .sortable{
        cursor: pointer;
        color: black;
        font-size: 12pt;
      }
      .unsorted {
        color: #c0c0c0;
      }

      /* iPhone portrait*/
      @media (max-width: 480px) and (max-width: 767px) {
        h1{
          font-size: 24px;
        }
        .sortable {
          /*color: green;*/
          font-size: 10pt;
        }
      }
      /* iPad portrait*/
      @media (min-width: 768px) and (max-width: 979px) {
        .sortable {
          /*color: yellow;*/
        }
      }
      @media (min-width: 1200px) {
        .sortable {
          /*color: red;*/
        }
      }date = moment(str_date,"YYYY-MM-DD HH:mm:ss");
            return date.format("DD/MM/YYYY HH:mm");
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <h1>Manual providers</h1>
      <script id='providers_template' type='text/ractive'>
        <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">

          <div class="panel panel-primary">
            <div class="panel-heading" role="tab" id="providerHeading">
              <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#providersCollapse" aria-expanded="false" aria-controls="providersCollapse">
                  Manual provider list <span class="badge">{{providers.length}}</small>
                </a>
              </h4>
            </div>
            <div id="providersCollapse" class="panel-collapse collapse" role="tabpanel" aria-labelledby="providerHeading">
              <div class="panel-body">
                <table class='table table-condensed'>
                  <thead>
                    <tr>
                      <th class='sortable' on-tap='sort:id'>
                        <span class='{{ sortColumn === "id" ? "glyphicon glyphicon-sort-by-attributes" : "unsorted glyphicon glyphicon-sort" }}'></span>Id
                      </th>
                      <th class='sortable' on-tap='sort:name'>
                        <span class='{{ sortColumn === "name" ? "glyphicon glyphicon-sort-by-attributes" : "unsorted glyphicon glyphicon-sort" }}'></span>Navn
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                  {{#each sort(providers, sortColumn) :num}}
                    <tr>
                      <td>{{id}}</td>
                      <td><a href="#" on-click="show" class="text-capitalize">{{name}}</a></td>
                    </tr>
                  {{/each}}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="panel panel-primary">
            <div class="panel-heading" role="tab" id="reportsHeading">
              <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#reportsCollapse" aria-expanded="false" aria-controls="reportsCollapse">
                  Reports list <span class="badge">{{reports.length}}</small></badge>
                </a>
              </h4>

            <div id="reportsCollapse" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="reportsHeading">
              <div class="panel-body">
                {{#if report}}
                  <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="reportHeading">
                      <div class="panel-title">
                        <h3 class="text-capitalize">{{report.provider}}</h3>
                        <small>{{dateFormat(report.date)}}</small>
                      </div>
                    </div>
                    <div class="panel-body">
                      <table class='table table-condensed'>
                        <thead>
                          <tr>
                            <th>Id</th>
                            <th>Address</th>
                            <th>Link</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td><span class="badge">{{report.added.length}}</badge> <strong>Added</strong></td>
                            <td></td>
                            <td></td>
                          </tr>
                          {{#each report.added}}
                            <tr>
                              <td>{{id}}</td>
                              <td>{{address}}</td>
                              <td><a href="{{href}}" target="_blank">Link</a></td>
                            </tr>
                          {{/each}}
                          <tr>
                            <td><span class="badge">{{report.removed.length}}</badge> <strong>Removed</strong></td>
                            <td></td>
                            <td></td>
                          </tr>
                          {{#each report.removed}}
                            <tr>
                              <td>{{id}}</td>
                              <td>{{address}}</td>
                              <td>{{href}}</td>
                            </tr>
                          {{/each}}
                        </tbody>
                      </table>
                    </div>
                  </div>
                {{/if}}
                <h5>
                  Latest synchronization
                  <button type="button" class="btn btn-xs btn-{{statusClass(job_report.status)}}" data-toggle="popover" data-html="true" title="Job report" data-content="
                  {{job_report.details}}<br/><br/>
                  <span class='label label-default'>{{job_report.rake_task}}</span><br/><br/>
                  Start: {{dateFormat(job_report.start_date)}}<br/>
                  Finished: {{dateFormat(job_report.end_date)}}<br/>
                  Status: {{job_report.status}}">{{dateFormat(job_report.end_date)}}</button>
                </h5>

                <table class='table table-condensed'>
                  <thead>
                    <tr>
                      <th class='sortable' on-tap='sort:id'>
                        <span class='{{ sortColumn === "id" ? "glyphicon glyphicon-sort-by-attributes" : "unsorted glyphicon glyphicon-sort" }}'></span>Date
                      </th>
                      <th class='sortable' on-tap='sort:name'>
                        <span class='{{ sortColumn === "name" ? "glyphicon glyphicon-sort-by-attributes" : "unsorted glyphicon glyphicon-sort" }}'></span>Provider
                      </th>
                      <th>
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                  {{#each sort(reports, 'date') :num}}
                    <tr>
                      <td><a href="#" on-click="show">{{dateFormat(date)}}</a></td>
                      <td><a href="#" on-click="show" class="text-capitalize">{{provider}}</a></td>

                      <td><a class="btn btn-{{stateClass(processed)}} btn-sm" href="#" on-click="toggleProcessed">{{state(processed)}}</a></td>
                    </tr>
                  {{/each}}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </script>
      <div id='providers_container'></div>
    </div>
    <script type="text/javascript">
      var DATABASE = "https://couch01.lokalebasen.dk";
      var providers = new Ractive({
        el: 'providers_container',
        template:  '#providers_template',
        data: {
          provider: null,
          report: null,
          providers: [],
          reports: [],
          job_report: null,
          dateFormat: function(str_date){
            date = moment(str_date,"YYYY-MM-DD HH:mm:ss");
            return date.format("DD/MM/YYYY HH:mm");
          },
          state: function(processed){
            return processed ? "Processed" : "Unprocessed";
          },
          stateClass: function(processed){
            return processed ? "success" : "default";
          },
          statusClass: function(status){
            return (status!="finished") ? "warning" : "success";
          },
          sort: function ( array, column ) {
            array = array.slice();
            return array.sort( function ( a, b ) {
              return a[ column ] > b[ column ] ? -1 : 1;
            });
          }
        }
      });
      providers.on( 'show', function ( event ) {
        showProviderReport(event.context._id)
      });
      providers.on( 'deleteReport', function ( event ) {
        deleteReport(event.context._id, event.context._rev);
      });
      providers.on( 'toggleProcessed', function ( event ) {
        toggleProcessed(event.context._id, event.context._rev);
      });
      providers.on( 'sort', function ( event, column ) {
        this.set( 'sortColumn', column );
      });

      function setProviders() {
        url = DATABASE + "/se_manual_providers/_design/lists/_view/providers"
        $.get(url, function( data ) {
          rows = JSON.parse(data).rows
          for (var j = 0; j < rows.length; j++) {
            var provider = {};
            provider.name = rows[j].key
            provider.id = rows[j].key
            providers.push( 'providers', provider );
          }
        });
      }

      function showProviderReport(id) {
        url = DATABASE + "/se_manual_providers/"+id
        $.get(url, function( data ) {
          report = JSON.parse(data);
          providers.set( 'report', report );
        });
      }

      function toggleProcessed(id, rev){
        doc_url = DATABASE+"/se_manual_providers/"+id
        $.get(doc_url, function( data ) {
          report = JSON.parse(data);
          report.processed = report.processed ? false : true;
          saveReport(doc_url+"?rev="+rev, report)
        });
      }

      function saveReport(doc_url, report){
        $.ajax({
            url: doc_url,
            type: 'PUT',
            data: JSON.stringify(report),
            success: function(result) {
              providers.set( 'reports', [] );
              setProviderReports();
            }
        });
      }

      function deleteReport(id, rev){
        shown_report = providers.get('report');
        if(shown_report && shown_report._id==id){ providers.set( 'report', null ); }
        doc_url = DATABASE+"/se_manual_providers/"+id+"?rev="+rev;
        $.ajax({
            url: doc_url,
            type: 'DELETE',
            success: function(result) {
              providers.set( 'reports', [] );
              setProviderReports()
            }
        });
      }

      function setProviderReports() {
        url = DATABASE + "/se_manual_providers/_design/lists/_view/reports"
        $.get(url, function( data ) {
          rows = JSON.parse(data).rows

          for (var j = 0; j < rows.length; j++) {
            report = rows[j].value
            if(report.processed==undefined)
              report.processed = false;
            providers.push( 'reports', report );
          }
        });
      }

      function setLatestJobReport(){
        url = DATABASE + '/job_reports/_design/lists/_view/rake?limit=1&descending=true&key="cronjobs:se_manual_providers_report"'
        $.get(url, function( data ) {
          rows = JSON.parse(data).rows;
          if(rows.length>0){
            job_report = rows[0].value;
            providers.set( 'job_report', job_report );
          }
        });
      }

      setProviders();
      setProviderReports();
      setLatestJobReport();
      $(function () {
        $('[data-toggle="popover"]').popover()
      })
    </script>
  </body>
</html>
