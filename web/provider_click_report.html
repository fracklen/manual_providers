<!DOCTYPE html>
<html lang="dk">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Aktive udbydere - emne visninger</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">

    <style>
      .sortable{
        cursor: pointer;
        color: black;
        font-size: 12pt;
      }
      .unsorted {
        color: #c0c0c0;
      }

      /* iPhone portrait*/
      @media (max-width: 480px) and (max-width: 767px) {
        h1{
          font-size: 24px;
        }
        .sortable {
          /*color: green;*/
          font-size: 10pt;
        }
      }
      /* iPad portrait*/
      @media (min-width: 768px) and (max-width: 979px) {
        .sortable {
          /*color: yellow;*/
        }
      }
      @media (min-width: 1200px) {
        .sortable {
          /*color: red;*/
        }
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <h1>Aktive udbydere - emne visninger</h1>
      <script id='providers_template' type='text/ractive'>
        <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
          <div class="panel panel-primary">
            <div class="panel-heading" role="tab" id="headingOne">
              <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                  Udbydere
                </a>
              </h4>
            </div>
            <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
              <div class="panel-body">
                <table class='table table-condensed'>
                  <thead>
                    <tr>
                      <th class='sortable' on-tap='sort:id'>
                        <span class='{{sortIcon("id")}}'></span>Id
                      </th>
                      <th class='sortable' on-tap='sort:company_name'>
                        <span class='{{sortIcon("company_name")}}'></span>Navn
                      </th>
                      <th class='sortable' on-tap='sort:total_active'>
                        <span class='{{sortIcon("total_active")}}'></span>Aktive lejemål
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                  {{#each sort(providers, sortColumn) :num}}
                    <tr>
                      <td>{{id}}</td>
                      <td><a href="#" on-click="show">{{company_name}}</a></td>
                      <td>
                        <span class="badge">
                          {{total_active}}
                        </span>
                      </td>
                    </tr>
                  {{/each}}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="panel panel-primary">
            <div class="panel-heading" role="tab" id="headingTwo">
              <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                  <h4>{{provider.company_name}} <small><span class="badge">{{provider.total_active}}</small></badge></h4>
                </a>
              </h4>
            </div>
            <div id="collapseTwo" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingTwo">
              <div class="panel-body">
                <table class='table table-condensed'>
                  <thead>
                    <tr>
                      <th>År-uge</th>
                      <th>Visninger</th>
                    </tr>
                  </thead>
                  <tbody>
                    {{#each provider.week_stats}}
                      <tr>
                        <td>{{week}}</td>
                        <td>{{formatNull(shown)}}</td>
                      </tr>
                    {{/each}}
                      <tr>
                        <td><strong>Total</strong></td>
                        <td><strong>{{provider.shown_sum}}</strong></td>
                      </tr>
                  </tbody>
                </table>
                <h2>Emner</h2>
                <table class='table table-condensed'>
                  <thead>
                    <tr>
                      <th>Id</th>
                      <th class='sortable' on-tap='sortLocation:adress'>
                        <span class='{{sortLocationIcon("adress")}}'></span>Adresse
                      </th>
                      <th>Status</th>
                      <th class='sortable' on-tap='sortLocation:clicks'>
                        <span class='{{sortLocationIcon("clicks")}}'></span>Visninger
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>
                        <span class="label label-primary">{{report.locations.length}}</span>
                        <span class="label label-success">{{active(report)}}</span>
                        <span class="label label-warning">{{nothing(report)}}</badge></td>
                      <td></td>
                      <td></td>
                    </tr>

                    {{#each sortLocation(provider.locations, sortLocationColumn) :num}}
                      <tr>
                        <td>{{id}}</td>
                        <td>{{adress}}</td>
                        <td><span class="label label-{{stateClass(state)}}">{{state}}</span></td>
                        <td>{{clicks}}</td>
                      </tr>
                    {{/each}}

                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </script>

      <div id='providers_container'></div>
    </div>
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src='http://cdn.ractivejs.org/latest/ractive.js'></script>
    <script src='http://sofa.lokalebasen.dk:5984/public/js/ractive-events-tap.js'></script>
    <script type="text/javascript">
      var DATABASE = "http://sofa-staging.lokalebasen.dk:5984";
      var providers = new Ractive({
        el: 'providers_container',
        template:  '#providers_template',
        data: {
          provider: null,
          providers: [],
          to_json: function ( provider ) {
            return JSON.stringify(provider);
          },
          formatNull: function(value){
            if(value)
              return value;
            else
              return 0;
          },
          dateFormat: function(str_date){
            date = new Date(Date.parse(str_date));
            return $.formatDateTime('dd/mm/yy hh:ii', date);
          },
          sortIcon: function(column){
            if(column === this.get('sortColumn')){
              icon = "glyphicon glyphicon-sort-by-attributes"
              return this.get('sortOrder') === "asc" ? icon+"-alt" :icon;
            }
            else
              return "unsorted glyphicon glyphicon-sort";
          },
          sortLocationIcon: function(column){
            if(column === this.get('sortLocationColumn')){
              icon = "glyphicon glyphicon-sort-by-attributes"
              return this.get('sortLocationOrder') === "asc" ? icon+"-alt" :icon;
            }
            else
              return "unsorted glyphicon glyphicon-sort";
          },
          statusClass: function(status){
            if(status!="finished")
              return "warning";
            else
              return "success";
          },
          stateClass: function(state){
            return classFromState(state);
          },
          sort: function ( array, column ) {
            sortOrder = this.get('sortOrder');
            array = array.slice();
            return array.sort( function ( a, b ) {
              if(sortOrder=="asc")
                return a[ column ] > b[ column ] ? -1 : 1;
              else
                return a[ column ] < b[ column ] ? -1 : 1;
            });
          },
          sortLocation: function ( array, column ) {
            sortOrder = this.get('sortLocationOrder');
            array = array.slice();
            return array.sort( function ( a, b ) {
              if(sortOrder=="asc")
                return a[ column ] > b[ column ] ? -1 : 1;
              else
                return a[ column ] < b[ column ] ? -1 : 1;
            });
          },
          sortColumn: 'company_name',
          sortOrder: 'asc',
          sortLocationColumn: 'clicks',
          sortLocationOrder: 'asc'
        }
      });
      providers.on( 'show', function ( event ) {
        showProvider(event.context)
      });
      providers.on( 'sortLocation', function ( event, column ) {
        current_sort = this.get('sortLocationColumn');
        new_sort = column;
        this.set( 'sortLocationColumn', column );
        this.set( 'sortLocationOrder', (this.get('sortLocationOrder') == 'asc' ? 'desc' : 'asc') );
        if(current_sort!=new_sort)
          this.set( 'sortLocationColumn', column );
        else
          this.set( 'sortLocationColumn', column );
      });

      providers.on( 'sort', function ( event, column ) {
        current_sort = this.get('sortColumn');
        new_sort = column;
        this.set( 'sortOrder', (this.get('sortOrder') == 'asc' ? 'desc' : 'asc') );
        if(current_sort!=new_sort)
          this.set( 'sortColumn', column );
        else
          this.set( 'sortColumn', column );
      });

      function classFromState(state)
      {
        switch (state) {
          case "active":
            return "success";
            break;
          case "closed":
            return "danger"
            break;
          case "new":
            return "warning";
            break;
          default:
            return "primary";
        }
      }

      function setProviders() {
        url = DATABASE + "/provider_active_locations_sum/_design/lists/_view/providers"
        $.get(url, function( data ) {
          rows = JSON.parse(data).rows

          provider_list = []

          for (var j = 0; j < rows.length; j++) {
            value = rows[j].value
            provider = {uuid: rows[j].id, company_name: value[1], id: parseInt(value[0]), total_active: value[2] }

            provider_list.push(provider)
          }
          provider_list.sort(function(a, b) {
            return b.active - a.active;
          });
          providers.set( 'providers', provider_list );
        });
      }

      function showProvider(provider){
        setLocationsShown(provider);
        setLocations(provider);
        $('#collapseOne').collapse('hide');
      }

      function weekQuery(uuid){
        startkey = 'startkey=["' + uuid + '",2014,40]';
        endkey = 'endkey=["' + uuid + '",'+moment().weekYear()+','+ moment().week()+']';
        query = startkey + "&" + endkey + "&group=true";
        return query;
      }

      function locationsQuery(uuid){
        startkey = 'startkey=["' + uuid + '",0]';
        endkey = 'endkey=["' + uuid + '",{}]';
        query = startkey + "&" + endkey + "&group=true";
        return query;
      }

      function setLocations(provider){
        provider.clicks = {};
        url = DATABASE + "/dk_location_shown/_design/stats/_view/grp_by_provider_location?" + locationsQuery(provider.uuid)
        $.get(url, function( data ) {
          locations_shown = JSON.parse(data).rows
          for(i = 0; i < locations_shown.length; i++){
            uuid = locations_shown[i].key[1]
            provider.clicks[uuid] = { uuid: uuid, amount: locations_shown[i].value };
          }
          addLocationAddress(provider);
        });
      }

      function addLocationAddress(provider){
          provider.locations = []
          url = DATABASE + '/dk_active_locations/_design/lists/_view/by_provider_uuid?key="'+provider.uuid+'"'
          $.get(url, function( data ) {
            locations = JSON.parse(data).rows
            for(i = 0; i < locations.length; i++){
              loc = locations[i].value;
              loc.clicks = provider.clicks[loc.uuid] ? provider.clicks[loc.uuid].amount : 0;
              provider.locations.push(loc);
            }
          });

      }

      function setLocationsShown(provider){
        url = DATABASE + "/dk_location_shown/_design/stats/_view/week?" + weekQuery(provider.uuid)
        $.get(url, function( data ) {
          locations_shown = JSON.parse(data).rows
          shown_sum = 0;
          week_stats = {}
          for(i = 0; i < locations_shown.length; i++){
            value = locations_shown[i].value
            key = locations_shown[i].key[1]+"-"+locations_shown[i].key[2]
            shown_sum = shown_sum + value
            week_stats[key] = { shown: value, week: key }
          }
          provider.shown_sum = shown_sum;
          provider.locations_shown = locations_shown;
          provider.week_stats = week_stats;
          setLocationsInfoClicked(provider);
        });
      }

      function setLocationsInfoClicked(provider){
        url = DATABASE + "/dk_location_contact_info_shown/_design/stats/_view/week?" + weekQuery(provider)
        $.get(url, function( data ) {
          locations_info_clicked = JSON.parse(data).rows
          clicked_sum = 0;
          for(i = 0; i < locations_info_clicked.length; i++){
            value = locations_info_clicked[i].value
            week_stat = week_stats[locations_info_clicked[i].key[1]+"-"+locations_info_clicked[i].key[2]]
            clicked_sum = clicked_sum + value
            week_stat['clicked'] = value
          }
          provider.clicked_sum = clicked_sum;
          provider.locations_info_clicked = locations_info_clicked
          providers.set( 'provider', provider );
          setGraph(provider);
        });
      }

      function valueOrZero(value){
        if(value)
          return value;
        else
          return 0;
      }

      function setGraph(provider){
        var data1 = [];
        var data2 = [];
        var labels = Object.keys(week_stats);
        for(i=0;i<labels.length;i++){
          label = labels[i]
          data1.push(valueOrZero(week_stats[label].shown));
          data2.push(valueOrZero(week_stats[label].clicked));
        }
        var options = {
          scaleShowGridLines : true,
          responsive : true,
          maintainAspectRatio: true,
          pointHitDetectionRadius: 5,
          bezierCurve: false
      };
        var data = {
          labels: labels,
          datasets: [
              {
                  label: "Visninger",
                  lineColor: "rgba(220,220,220,1)",
                  fillColor: "rgba(220,220,220,0.2)",
                  strokeColor: "rgba(220,220,220,1)",
                  pointColor: "rgba(220,220,220,1)",
                  pointStrokeColor: "#fff",
                  pointHighlightFill: "#fff",
                  pointHighlightStroke: "rgba(220,220,220,1)",
                  data: data1
              },
              {
                  label: "Info-kliks",
                  lineColor: "rgba(151,187,205,1)",
                  fillColor: "rgba(151,187,205,0.2)",
                  strokeColor: "rgba(58,185,3,1)",
                  pointColor: "rgba(58,185,3,1)",
                  pointStrokeColor: "#fff",
                  pointHighlightFill: "#fff",
                  pointHighlightStroke: "rgba(58,185,3,1)",
                  data: data2
              }
          ]
        };

      }

      setProviders();
    </script>


  </body>
</html>
